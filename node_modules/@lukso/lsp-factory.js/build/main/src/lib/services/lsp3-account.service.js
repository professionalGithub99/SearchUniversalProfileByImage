"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.transferOwnership = exports.getTransferOwnershipTransaction$ = exports.setData = exports.lsp3ProfileUpload$ = exports.isLSP3ProfileDataEncoded = exports.getLsp3ProfileDataUrl = exports.setDataTransaction$ = exports.deployProxyContract = exports.accountDeploymentWithBaseContractAddress$ = exports.accountDeployment$ = void 0;
const axios_1 = __importDefault(require("axios"));
const ethers_1 = require("ethers");
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const __1 = require("../..");
const config_helper_1 = require("../helpers/config.helper");
const deployment_helper_1 = require("../helpers/deployment.helper");
const erc725_helper_1 = require("../helpers/erc725.helper");
const interfaces_1 = require("../interfaces");
function accountDeployment$(signer, controllerAddresses, baseContractAddresses$) {
    return baseContractAddresses$.pipe((0, operators_1.switchMap)((baseContractAddresses) => {
        return accountDeploymentWithBaseContractAddress$(signer, controllerAddresses, baseContractAddresses.ERC725Account);
    }), (0, operators_1.shareReplay)());
}
exports.accountDeployment$ = accountDeployment$;
function accountDeploymentWithBaseContractAddress$(signer, controllerAddresses, baseContractAddress) {
    const accountDeployment$ = (0, rxjs_1.defer)(() => deployLSP3Account(signer, controllerAddresses, baseContractAddress)).pipe((0, operators_1.shareReplay)());
    const accountDeploymentReceipt$ = (0, deployment_helper_1.waitForReceipt)(accountDeployment$).pipe((0, operators_1.shareReplay)());
    const accountDeploymentInitialize$ = baseContractAddress
        ? initializeProxy(signer, accountDeploymentReceipt$)
        : rxjs_1.EMPTY;
    const accountDeploymentInitializeReceipt$ = (0, deployment_helper_1.waitForReceipt)(accountDeploymentInitialize$).pipe((0, operators_1.shareReplay)());
    return (0, rxjs_1.concat)(accountDeployment$, accountDeploymentReceipt$, accountDeploymentInitialize$, accountDeploymentInitializeReceipt$);
}
exports.accountDeploymentWithBaseContractAddress$ = accountDeploymentWithBaseContractAddress$;
async function deployLSP3Account(signer, ownerAddresses, baseContractAddress) {
    const deploymentFunction = async () => {
        return baseContractAddress
            ? new __1.UniversalProfileInit__factory(signer).attach(baseContractAddress)
            : await new __1.UniversalProfile__factory(signer).deploy(ownerAddresses[0]);
    };
    return baseContractAddress
        ? deployProxyContract(deploymentFunction, signer)
        : (0, deployment_helper_1.deployContract)(deploymentFunction, interfaces_1.ContractNames.ERC725_Account);
}
async function deployProxyContract(deployContractFunction, signer) {
    try {
        const contract = await deployContractFunction();
        const factory = new ethers_1.ContractFactory(__1.UniversalProfile__factory.abi, (0, deployment_helper_1.getProxyByteCode)(contract.address), signer);
        const deployedProxy = await factory.deploy(signer.getAddress());
        const transaction = deployedProxy.deployTransaction;
        return {
            type: interfaces_1.DeploymentType.PROXY,
            contractName: interfaces_1.ContractNames.ERC725_Account,
            status: interfaces_1.DeploymentStatus.PENDING,
            transaction,
        };
    }
    catch (error) {
        console.error(`Error when deploying ${interfaces_1.ContractNames.ERC725_Account}`, error);
        throw error;
    }
}
exports.deployProxyContract = deployProxyContract;
function initializeProxy(signer, accountDeploymentReceipt$) {
    return (0, deployment_helper_1.initialize)(accountDeploymentReceipt$, new __1.UniversalProfileInit__factory(signer), async () => {
        const signerAddress = await signer.getAddress();
        return [signerAddress];
    }).pipe((0, operators_1.shareReplay)());
}
function setDataTransaction$(signer, account$, universalReceiver$, controllerAddresses, lsp3ProfileData$) {
    const setDataTransaction$ = (0, rxjs_1.forkJoin)([account$, universalReceiver$, lsp3ProfileData$]).pipe((0, operators_1.switchMap)(([{ receipt: lsp3AccountReceipt }, { receipt: universalReceiverDelegateReceipt }, lsp3ProfileData,]) => {
        return setData(signer, lsp3AccountReceipt.contractAddress || lsp3AccountReceipt.to, universalReceiverDelegateReceipt.contractAddress || universalReceiverDelegateReceipt.to, controllerAddresses, lsp3ProfileData);
    }), (0, operators_1.shareReplay)());
    const setDataReceipt$ = (0, deployment_helper_1.waitForReceipt)(setDataTransaction$);
    return (0, rxjs_1.concat)(setDataTransaction$, setDataReceipt$);
}
exports.setDataTransaction$ = setDataTransaction$;
async function getLsp3ProfileDataUrl(lsp3Profile) {
    let lsp3ProfileData;
    if (typeof lsp3Profile === 'string') {
        let lsp3JsonUrl = lsp3Profile;
        const isIPFSUrl = lsp3Profile.startsWith('ipfs://');
        if (isIPFSUrl) {
            lsp3JsonUrl = 'https://ipfs.lukso.network/ipfs/' + lsp3Profile.split('/').at(-1); // TODO: Allow custom IPFS upload location
        }
        const ipfsResponse = await axios_1.default.get(lsp3JsonUrl);
        const lsp3ProfileJson = ipfsResponse.data;
        lsp3ProfileData = {
            url: lsp3Profile,
            profile: lsp3ProfileJson,
        };
    }
    else {
        lsp3ProfileData = await __1.LSP3UniversalProfile.uploadProfileData(lsp3Profile);
    }
    return lsp3ProfileData;
}
exports.getLsp3ProfileDataUrl = getLsp3ProfileDataUrl;
function isLSP3ProfileDataEncoded(lsp3Profile) {
    if (!lsp3Profile.startsWith('ipfs://') && !lsp3Profile.startsWith('https://')) {
        return true;
    }
    return false;
}
exports.isLSP3ProfileDataEncoded = isLSP3ProfileDataEncoded;
function lsp3ProfileUpload$(lsp3Profile) {
    let lsp3Profile$;
    if (typeof lsp3Profile !== 'string' || !isLSP3ProfileDataEncoded(lsp3Profile)) {
        lsp3Profile$ = lsp3Profile ? (0, rxjs_1.from)(getLsp3ProfileDataUrl(lsp3Profile)) : (0, rxjs_1.of)(null);
    }
    else {
        lsp3Profile$ = (0, rxjs_1.of)(lsp3Profile);
    }
    return lsp3Profile$;
}
exports.lsp3ProfileUpload$ = lsp3ProfileUpload$;
/**
 * TODO: docs
 */
async function setData(signer, erc725AccountAddress, universalReceiverDelegateAddress, controllerAddresses, lsp3Profile) {
    let encodedLSP3Profile;
    if (lsp3Profile && typeof lsp3Profile !== 'string') {
        const encodedDataResult = lsp3Profile
            ? (0, erc725_helper_1.encodeLSP3Profile)(lsp3Profile.profile, lsp3Profile.url)
            : null;
        encodedLSP3Profile = encodedDataResult.LSP3Profile.value;
    }
    else {
        encodedLSP3Profile = lsp3Profile;
    }
    const erc725Account = new __1.UniversalProfile__factory(signer).attach(erc725AccountAddress);
    let controllerAddress;
    let signerPermissions;
    if (typeof controllerAddresses[0] === 'string') {
        controllerAddress = controllerAddresses[0];
    }
    else {
        controllerAddress = controllerAddresses[0].address;
        signerPermissions = controllerAddresses[0].permissions;
    }
    const keysToSet = [
        config_helper_1.LSP3_UP_KEYS.UNIVERSAL_RECEIVER_DELEGATE_KEY,
        config_helper_1.PREFIX_PERMISSIONS + controllerAddress.substr(2),
        config_helper_1.PREFIX_PERMISSIONS + universalReceiverDelegateAddress.substr(2),
        config_helper_1.ADDRESS_PERMISSIONS_ARRAY_KEY,
        config_helper_1.ADDRESS_PERMISSIONS_ARRAY_KEY.slice(0, 34) + '00000000000000000000000000000000',
        config_helper_1.ADDRESS_PERMISSIONS_ARRAY_KEY.slice(0, 34) + '00000000000000000000000000000001',
    ];
    const valuesToSet = [
        universalReceiverDelegateAddress,
        signerPermissions !== null && signerPermissions !== void 0 ? signerPermissions : config_helper_1.ALL_PERMISSIONS,
        config_helper_1.SET_DATA_PERMISSION,
        2,
        controllerAddress,
        universalReceiverDelegateAddress,
    ];
    if (encodedLSP3Profile) {
        keysToSet.push(config_helper_1.LSP3_UP_KEYS.LSP3_PROFILE);
        valuesToSet.push(encodedLSP3Profile);
    }
    const transaction = await erc725Account.setData(keysToSet, valuesToSet, {
        gasLimit: 1000000,
    });
    return {
        type: interfaces_1.DeploymentType.TRANSACTION,
        contractName: interfaces_1.ContractNames.ERC725_Account,
        functionName: 'setData',
        status: interfaces_1.DeploymentStatus.PENDING,
        transaction,
    };
}
exports.setData = setData;
function getTransferOwnershipTransaction$(signer, accountDeployment$, keyManagerDeployment$) {
    const transferOwnershipTransaction$ = (0, rxjs_1.forkJoin)([accountDeployment$, keyManagerDeployment$]).pipe((0, operators_1.switchMap)(([{ receipt: lsp3AccountReceipt }, { receipt: keyManagerContract }]) => {
        return transferOwnership(signer, lsp3AccountReceipt, keyManagerContract);
    }), (0, operators_1.shareReplay)());
    const transferOwnershipReceipt$ = (0, deployment_helper_1.waitForReceipt)(transferOwnershipTransaction$);
    return (0, rxjs_1.concat)(transferOwnershipTransaction$, transferOwnershipReceipt$);
}
exports.getTransferOwnershipTransaction$ = getTransferOwnershipTransaction$;
/**
 * TODO: docs
 */
async function transferOwnership(signer, lsp3AccountReceipt, keyManagerReceipt) {
    try {
        const signerAddress = await signer.getAddress();
        const contract = new __1.UniversalProfile__factory(signer).attach(lsp3AccountReceipt.contractAddress || lsp3AccountReceipt.to);
        const transaction = await contract.transferOwnership(keyManagerReceipt.contractAddress || keyManagerReceipt.to, {
            from: signerAddress,
            gasLimit: 500000,
        });
        return {
            type: interfaces_1.DeploymentType.TRANSACTION,
            status: interfaces_1.DeploymentStatus.PENDING,
            contractName: interfaces_1.ContractNames.ERC725_Account,
            functionName: 'transferOwnership',
            transaction,
        };
    }
    catch (error) {
        console.error('Error when transferring Ownership', error);
        throw error;
    }
}
exports.transferOwnership = transferOwnership;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibHNwMy1hY2NvdW50LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvbGliL3NlcnZpY2VzL2xzcDMtYWNjb3VudC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUNBLGtEQUEwQjtBQUMxQixtQ0FBc0U7QUFDdEUsK0JBQTRFO0FBQzVFLDhDQUF3RDtBQUV4RCw2QkFJZTtBQUNmLDREQU1rQztBQUNsQyxvRUFLc0M7QUFDdEMsNERBQTZEO0FBQzdELDhDQVd1QjtBQU92QixTQUFnQixrQkFBa0IsQ0FDaEMsTUFBYyxFQUNkLG1CQUE2QixFQUM3QixzQkFHRTtJQUVGLE9BQU8sc0JBQXNCLENBQUMsSUFBSSxDQUNoQyxJQUFBLHFCQUFTLEVBQUMsQ0FBQyxxQkFBcUIsRUFBRSxFQUFFO1FBQ2xDLE9BQU8seUNBQXlDLENBQzlDLE1BQU0sRUFDTixtQkFBbUIsRUFDbkIscUJBQXFCLENBQUMsYUFBYSxDQUNwQyxDQUFDO0lBQ0osQ0FBQyxDQUFDLEVBQ0YsSUFBQSx1QkFBVyxHQUFFLENBQ2QsQ0FBQztBQUNKLENBQUM7QUFsQkQsZ0RBa0JDO0FBRUQsU0FBZ0IseUNBQXlDLENBQ3ZELE1BQWMsRUFDZCxtQkFBNkIsRUFDN0IsbUJBQTJCO0lBRTNCLE1BQU0sa0JBQWtCLEdBQUcsSUFBQSxZQUFLLEVBQUMsR0FBRyxFQUFFLENBQ3BDLGlCQUFpQixDQUFDLE1BQU0sRUFBRSxtQkFBbUIsRUFBRSxtQkFBbUIsQ0FBQyxDQUNwRSxDQUFDLElBQUksQ0FBQyxJQUFBLHVCQUFXLEdBQUUsQ0FBQyxDQUFDO0lBRXRCLE1BQU0seUJBQXlCLEdBQUcsSUFBQSxrQ0FBYyxFQUM5QyxrQkFBa0IsQ0FDbkIsQ0FBQyxJQUFJLENBQUMsSUFBQSx1QkFBVyxHQUFFLENBQUMsQ0FBQztJQUV0QixNQUFNLDRCQUE0QixHQUFHLG1CQUFtQjtRQUN0RCxDQUFDLENBQUMsZUFBZSxDQUFDLE1BQU0sRUFBRSx5QkFBcUUsQ0FBQztRQUNoRyxDQUFDLENBQUMsWUFBSyxDQUFDO0lBRVYsTUFBTSxtQ0FBbUMsR0FBRyxJQUFBLGtDQUFjLEVBQ3hELDRCQUE0QixDQUM3QixDQUFDLElBQUksQ0FBQyxJQUFBLHVCQUFXLEdBQUUsQ0FBQyxDQUFDO0lBRXRCLE9BQU8sSUFBQSxhQUFNLEVBQ1gsa0JBQWtCLEVBQ2xCLHlCQUF5QixFQUN6Qiw0QkFBNEIsRUFDNUIsbUNBQW1DLENBQ3BDLENBQUM7QUFDSixDQUFDO0FBM0JELDhGQTJCQztBQUVELEtBQUssVUFBVSxpQkFBaUIsQ0FDOUIsTUFBYyxFQUNkLGNBQXdCLEVBQ3hCLG1CQUEyQjtJQUUzQixNQUFNLGtCQUFrQixHQUFHLEtBQUssSUFBSSxFQUFFO1FBQ3BDLE9BQU8sbUJBQW1CO1lBQ3hCLENBQUMsQ0FBQyxJQUFJLGlDQUE2QixDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQztZQUN2RSxDQUFDLENBQUMsTUFBTSxJQUFJLDZCQUF5QixDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUM1RSxDQUFDLENBQUM7SUFFRixPQUFPLG1CQUFtQjtRQUN4QixDQUFDLENBQUMsbUJBQW1CLENBQUMsa0JBQWtCLEVBQUUsTUFBTSxDQUFDO1FBQ2pELENBQUMsQ0FBQyxJQUFBLGtDQUFjLEVBQUMsa0JBQWtCLEVBQUUsMEJBQWEsQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUN2RSxDQUFDO0FBRU0sS0FBSyxVQUFVLG1CQUFtQixDQUN2QyxzQkFBc0IsRUFDdEIsTUFBYztJQUVkLElBQUk7UUFDRixNQUFNLFFBQVEsR0FBYSxNQUFNLHNCQUFzQixFQUFFLENBQUM7UUFDMUQsTUFBTSxPQUFPLEdBQUcsSUFBSSx3QkFBZSxDQUNqQyw2QkFBeUIsQ0FBQyxHQUFHLEVBQzdCLElBQUEsb0NBQWdCLEVBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxFQUNsQyxNQUFNLENBQ1AsQ0FBQztRQUNGLE1BQU0sYUFBYSxHQUFHLE1BQU0sT0FBTyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQztRQUNoRSxNQUFNLFdBQVcsR0FBRyxhQUFhLENBQUMsaUJBQWlCLENBQUM7UUFDcEQsT0FBTztZQUNMLElBQUksRUFBRSwyQkFBYyxDQUFDLEtBQUs7WUFDMUIsWUFBWSxFQUFFLDBCQUFhLENBQUMsY0FBYztZQUMxQyxNQUFNLEVBQUUsNkJBQWdCLENBQUMsT0FBTztZQUNoQyxXQUFXO1NBQ1osQ0FBQztLQUNIO0lBQUMsT0FBTyxLQUFLLEVBQUU7UUFDZCxPQUFPLENBQUMsS0FBSyxDQUFDLHdCQUF3QiwwQkFBYSxDQUFDLGNBQWMsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzdFLE1BQU0sS0FBSyxDQUFDO0tBQ2I7QUFDSCxDQUFDO0FBdkJELGtEQXVCQztBQUVELFNBQVMsZUFBZSxDQUN0QixNQUFjLEVBQ2QseUJBQW1FO0lBRW5FLE9BQU8sSUFBQSw4QkFBVSxFQUNmLHlCQUF5QixFQUN6QixJQUFJLGlDQUE2QixDQUFDLE1BQU0sQ0FBQyxFQUN6QyxLQUFLLElBQUksRUFBRTtRQUNULE1BQU0sYUFBYSxHQUFHLE1BQU0sTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQ2hELE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUN6QixDQUFDLENBQ0YsQ0FBQyxJQUFJLENBQUMsSUFBQSx1QkFBVyxHQUFFLENBQUMsQ0FBQztBQUN4QixDQUFDO0FBRUQsU0FBZ0IsbUJBQW1CLENBQ2pDLE1BQWMsRUFDZCxRQUFnRCxFQUNoRCxrQkFBZ0UsRUFDaEUsbUJBQW1ELEVBQ25ELGdCQUF3RTtJQUV4RSxNQUFNLG1CQUFtQixHQUFHLElBQUEsZUFBUSxFQUFDLENBQUMsUUFBUSxFQUFFLGtCQUFrQixFQUFFLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQ3pGLElBQUEscUJBQVMsRUFDUCxDQUFDLENBQ0MsRUFBRSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsRUFDL0IsRUFBRSxPQUFPLEVBQUUsZ0NBQWdDLEVBQUUsRUFDN0MsZUFBZSxFQUNoQixFQUFFLEVBQUU7UUFDSCxPQUFPLE9BQU8sQ0FDWixNQUFNLEVBQ04sa0JBQWtCLENBQUMsZUFBZSxJQUFJLGtCQUFrQixDQUFDLEVBQUUsRUFDM0QsZ0NBQWdDLENBQUMsZUFBZSxJQUFJLGdDQUFnQyxDQUFDLEVBQUUsRUFDdkYsbUJBQW1CLEVBQ25CLGVBQWUsQ0FDaEIsQ0FBQztJQUNKLENBQUMsQ0FDRixFQUNELElBQUEsdUJBQVcsR0FBRSxDQUNkLENBQUM7SUFFRixNQUFNLGVBQWUsR0FBRyxJQUFBLGtDQUFjLEVBQTZCLG1CQUFtQixDQUFDLENBQUM7SUFDeEYsT0FBTyxJQUFBLGFBQU0sRUFBQyxtQkFBbUIsRUFBRSxlQUFlLENBQUMsQ0FBQztBQUN0RCxDQUFDO0FBNUJELGtEQTRCQztBQUVNLEtBQUssVUFBVSxxQkFBcUIsQ0FDekMsV0FBNkM7SUFFN0MsSUFBSSxlQUdILENBQUM7SUFFRixJQUFJLE9BQU8sV0FBVyxLQUFLLFFBQVEsRUFBRTtRQUNuQyxJQUFJLFdBQVcsR0FBRyxXQUFXLENBQUM7UUFDOUIsTUFBTSxTQUFTLEdBQUcsV0FBVyxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUVwRCxJQUFJLFNBQVMsRUFBRTtZQUNiLFdBQVcsR0FBRyxrQ0FBa0MsR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsMENBQTBDO1NBQzdIO1FBRUQsTUFBTSxZQUFZLEdBQUcsTUFBTSxlQUFLLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ2xELE1BQU0sZUFBZSxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUM7UUFFMUMsZUFBZSxHQUFHO1lBQ2hCLEdBQUcsRUFBRSxXQUFXO1lBQ2hCLE9BQU8sRUFBRSxlQUFrQztTQUM1QyxDQUFDO0tBQ0g7U0FBTTtRQUNMLGVBQWUsR0FBRyxNQUFNLHdCQUFvQixDQUFDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxDQUFDO0tBQzdFO0lBRUQsT0FBTyxlQUFlLENBQUM7QUFDekIsQ0FBQztBQTVCRCxzREE0QkM7QUFFRCxTQUFnQix3QkFBd0IsQ0FBQyxXQUFtQjtJQUMxRCxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLEVBQUU7UUFDN0UsT0FBTyxJQUFJLENBQUM7S0FDYjtJQUVELE9BQU8sS0FBSyxDQUFDO0FBQ2YsQ0FBQztBQU5ELDREQU1DO0FBRUQsU0FBZ0Isa0JBQWtCLENBQUMsV0FBNkM7SUFDOUUsSUFBSSxZQUE2RCxDQUFDO0lBRWxFLElBQUksT0FBTyxXQUFXLEtBQUssUUFBUSxJQUFJLENBQUMsd0JBQXdCLENBQUMsV0FBVyxDQUFDLEVBQUU7UUFDN0UsWUFBWSxHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUMsSUFBQSxXQUFJLEVBQUMscUJBQXFCLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBQSxTQUFFLEVBQUMsSUFBSSxDQUFDLENBQUM7S0FDbEY7U0FBTTtRQUNMLFlBQVksR0FBRyxJQUFBLFNBQUUsRUFBQyxXQUFXLENBQUMsQ0FBQztLQUNoQztJQUVELE9BQU8sWUFBWSxDQUFDO0FBQ3RCLENBQUM7QUFWRCxnREFVQztBQUVEOztHQUVHO0FBQ0ksS0FBSyxVQUFVLE9BQU8sQ0FDM0IsTUFBYyxFQUNkLG9CQUE0QixFQUM1QixnQ0FBd0MsRUFDeEMsbUJBQW1ELEVBQ25ELFdBQWlEO0lBRWpELElBQUksa0JBQWtCLENBQUM7SUFDdkIsSUFBSSxXQUFXLElBQUksT0FBTyxXQUFXLEtBQUssUUFBUSxFQUFFO1FBQ2xELE1BQU0saUJBQWlCLEdBQUcsV0FBVztZQUNuQyxDQUFDLENBQUMsSUFBQSxpQ0FBaUIsRUFBQyxXQUFXLENBQUMsT0FBTyxFQUFFLFdBQVcsQ0FBQyxHQUFHLENBQUM7WUFDekQsQ0FBQyxDQUFDLElBQUksQ0FBQztRQUVULGtCQUFrQixHQUFHLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUM7S0FDMUQ7U0FBTTtRQUNMLGtCQUFrQixHQUFHLFdBQVcsQ0FBQztLQUNsQztJQUVELE1BQU0sYUFBYSxHQUFHLElBQUksNkJBQXlCLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBTSxDQUFDLG9CQUFvQixDQUFDLENBQUM7SUFFekYsSUFBSSxpQkFBeUIsQ0FBQztJQUM5QixJQUFJLGlCQUF5QixDQUFDO0lBRTlCLElBQUksT0FBTyxtQkFBbUIsQ0FBQyxDQUFDLENBQUMsS0FBSyxRQUFRLEVBQUU7UUFDOUMsaUJBQWlCLEdBQUcsbUJBQW1CLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDNUM7U0FBTTtRQUNMLGlCQUFpQixHQUFHLG1CQUFtQixDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztRQUNuRCxpQkFBaUIsR0FBRyxtQkFBbUIsQ0FBQyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUM7S0FDeEQ7SUFFRCxNQUFNLFNBQVMsR0FBRztRQUNoQiw0QkFBWSxDQUFDLCtCQUErQjtRQUM1QyxrQ0FBa0IsR0FBRyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1FBQ2hELGtDQUFrQixHQUFHLGdDQUFnQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFDL0QsNkNBQTZCO1FBQzdCLDZDQUE2QixDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEdBQUcsa0NBQWtDO1FBQy9FLDZDQUE2QixDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEdBQUcsa0NBQWtDO0tBQ2hGLENBQUM7SUFFRixNQUFNLFdBQVcsR0FBRztRQUNsQixnQ0FBZ0M7UUFDaEMsaUJBQWlCLGFBQWpCLGlCQUFpQixjQUFqQixpQkFBaUIsR0FBSSwrQkFBZTtRQUNwQyxtQ0FBbUI7UUFDbkIsQ0FBQztRQUNELGlCQUFpQjtRQUNqQixnQ0FBZ0M7S0FDakMsQ0FBQztJQUVGLElBQUksa0JBQWtCLEVBQUU7UUFDdEIsU0FBUyxDQUFDLElBQUksQ0FBQyw0QkFBWSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQzFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQztLQUN0QztJQUVELE1BQU0sV0FBVyxHQUFHLE1BQU0sYUFBYSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsV0FBMEIsRUFBRTtRQUNyRixRQUFRLEVBQUUsT0FBUztLQUNwQixDQUFDLENBQUM7SUFFSCxPQUFPO1FBQ0wsSUFBSSxFQUFFLDJCQUFjLENBQUMsV0FBVztRQUNoQyxZQUFZLEVBQUUsMEJBQWEsQ0FBQyxjQUFjO1FBQzFDLFlBQVksRUFBRSxTQUFTO1FBQ3ZCLE1BQU0sRUFBRSw2QkFBZ0IsQ0FBQyxPQUFPO1FBQ2hDLFdBQVc7S0FDWixDQUFDO0FBQ0osQ0FBQztBQWhFRCwwQkFnRUM7QUFFRCxTQUFnQixnQ0FBZ0MsQ0FDOUMsTUFBYyxFQUNkLGtCQUFvQyxFQUNwQyxxQkFBdUM7SUFFdkMsTUFBTSw2QkFBNkIsR0FBRyxJQUFBLGVBQVEsRUFBQyxDQUFDLGtCQUFrQixFQUFFLHFCQUFxQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQzlGLElBQUEscUJBQVMsRUFBQyxDQUFDLENBQUMsRUFBRSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsRUFBRSxFQUFFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUMvRSxPQUFPLGlCQUFpQixDQUFDLE1BQU0sRUFBRSxrQkFBa0IsRUFBRSxrQkFBa0IsQ0FBQyxDQUFDO0lBQzNFLENBQUMsQ0FBQyxFQUNGLElBQUEsdUJBQVcsR0FBRSxDQUNkLENBQUM7SUFDRixNQUFNLHlCQUF5QixHQUFHLElBQUEsa0NBQWMsRUFDOUMsNkJBQTZCLENBQzlCLENBQUM7SUFDRixPQUFPLElBQUEsYUFBTSxFQUFDLDZCQUE2QixFQUFFLHlCQUF5QixDQUFDLENBQUM7QUFDMUUsQ0FBQztBQWZELDRFQWVDO0FBRUQ7O0dBRUc7QUFDSSxLQUFLLFVBQVUsaUJBQWlCLENBQ3JDLE1BQWMsRUFDZCxrQkFBc0MsRUFDdEMsaUJBQXFDO0lBRXJDLElBQUk7UUFDRixNQUFNLGFBQWEsR0FBRyxNQUFNLE1BQU0sQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUNoRCxNQUFNLFFBQVEsR0FBRyxJQUFJLDZCQUF5QixDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FDM0Qsa0JBQWtCLENBQUMsZUFBZSxJQUFJLGtCQUFrQixDQUFDLEVBQUUsQ0FDNUQsQ0FBQztRQUNGLE1BQU0sV0FBVyxHQUFHLE1BQU0sUUFBUSxDQUFDLGlCQUFpQixDQUNsRCxpQkFBaUIsQ0FBQyxlQUFlLElBQUksaUJBQWlCLENBQUMsRUFBRSxFQUN6RDtZQUNFLElBQUksRUFBRSxhQUFhO1lBQ25CLFFBQVEsRUFBRSxNQUFPO1NBQ2xCLENBQ0YsQ0FBQztRQUVGLE9BQU87WUFDTCxJQUFJLEVBQUUsMkJBQWMsQ0FBQyxXQUFXO1lBQ2hDLE1BQU0sRUFBRSw2QkFBZ0IsQ0FBQyxPQUFPO1lBQ2hDLFlBQVksRUFBRSwwQkFBYSxDQUFDLGNBQWM7WUFDMUMsWUFBWSxFQUFFLG1CQUFtQjtZQUNqQyxXQUFXO1NBQ1osQ0FBQztLQUNIO0lBQUMsT0FBTyxLQUFLLEVBQUU7UUFDZCxPQUFPLENBQUMsS0FBSyxDQUFDLG1DQUFtQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzFELE1BQU0sS0FBSyxDQUFDO0tBQ2I7QUFDSCxDQUFDO0FBN0JELDhDQTZCQyJ9