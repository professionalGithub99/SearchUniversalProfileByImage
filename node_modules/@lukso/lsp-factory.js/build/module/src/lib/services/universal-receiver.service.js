var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
import { concat, EMPTY } from 'rxjs';
import { shareReplay, switchMap, takeLast } from 'rxjs/operators';
import { LSP1UniversalReceiverDelegate__factory, LSP1UniversalReceiverDelegateInit__factory, } from '../..';
import { deployContract, deployProxyContract, initialize, waitForReceipt, } from '../helpers/deployment.helper';
import { ContractNames } from '../interfaces';
export function universalReceiverDelegateDeployment$(signer, accountDeployment$, baseContractDeployment$) {
    return baseContractDeployment$.pipe(switchMap((baseContractAddresses) => {
        return universalReceiverDelegateDeploymentWithBaseContractAddress$(signer, accountDeployment$, baseContractAddresses.UniversalReceiverDelegate);
    }), shareReplay());
}
export function universalReceiverDelegateDeploymentWithBaseContractAddress$(signer, accountDeployment$, baseContractAddress) {
    const universalReceiverDelegateDeployment$ = accountDeployment$.pipe(takeLast(1), switchMap((result) => {
        return deployUniversalReceiverDelegateStore(signer, result.receipt.contractAddress, baseContractAddress);
    }), shareReplay());
    const universalReceiverDelegateStoreReceipt$ = waitForReceipt(universalReceiverDelegateDeployment$);
    const universalReceiverDelegateInitialize$ = baseContractAddress
        ? initializeProxy(signer, universalReceiverDelegateStoreReceipt$)
        : EMPTY;
    const universalReceiverDelegateInitializeReceipt$ = waitForReceipt(universalReceiverDelegateInitialize$);
    return concat(universalReceiverDelegateDeployment$, universalReceiverDelegateStoreReceipt$, universalReceiverDelegateInitialize$, universalReceiverDelegateInitializeReceipt$);
}
/**
 * TODO: docs
 */
export function deployUniversalReceiverDelegateStore(signer, lsp3AccountAddress, baseContractAddress) {
    return __awaiter(this, void 0, void 0, function* () {
        lsp3AccountAddress;
        const deploymentFunction = () => __awaiter(this, void 0, void 0, function* () {
            return baseContractAddress
                ? new LSP1UniversalReceiverDelegateInit__factory(signer).attach(baseContractAddress)
                : yield new LSP1UniversalReceiverDelegate__factory(signer).deploy({
                    gasLimit: 3000000,
                });
        });
        return baseContractAddress
            ? deployProxyContract(LSP1UniversalReceiverDelegateInit__factory.abi, deploymentFunction, ContractNames.UNIVERSAL_RECEIVER, signer)
            : deployContract(deploymentFunction, ContractNames.UNIVERSAL_RECEIVER);
    });
}
function initializeProxy(signer, universalReceiverDelegateReceipt$) {
    return initialize(universalReceiverDelegateReceipt$, new LSP1UniversalReceiverDelegateInit__factory(signer), () => __awaiter(this, void 0, void 0, function* () {
        return [];
    }));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidW5pdmVyc2FsLXJlY2VpdmVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvbGliL3NlcnZpY2VzL3VuaXZlcnNhbC1yZWNlaXZlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUNBLE9BQU8sRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQ2pELE9BQU8sRUFBRSxXQUFXLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRWxFLE9BQU8sRUFHTCxzQ0FBc0MsRUFDdEMsMENBQTBDLEdBQzNDLE1BQU0sT0FBTyxDQUFDO0FBQ2YsT0FBTyxFQUNMLGNBQWMsRUFDZCxtQkFBbUIsRUFDbkIsVUFBVSxFQUNWLGNBQWMsR0FDZixNQUFNLDhCQUE4QixDQUFDO0FBQ3RDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFROUMsTUFBTSxVQUFVLG9DQUFvQyxDQUNsRCxNQUFjLEVBQ2Qsa0JBQTBELEVBQzFELHVCQUdFO0lBRUYsT0FBTyx1QkFBdUIsQ0FBQyxJQUFJLENBQ2pDLFNBQVMsQ0FBQyxDQUFDLHFCQUFxQixFQUFFLEVBQUU7UUFDbEMsT0FBTywyREFBMkQsQ0FDaEUsTUFBTSxFQUNOLGtCQUFrQixFQUNsQixxQkFBcUIsQ0FBQyx5QkFBeUIsQ0FDaEQsQ0FBQztJQUNKLENBQUMsQ0FBQyxFQUNGLFdBQVcsRUFBRSxDQUNkLENBQUM7QUFDSixDQUFDO0FBRUQsTUFBTSxVQUFVLDJEQUEyRCxDQUN6RSxNQUFjLEVBQ2Qsa0JBQTBELEVBQzFELG1CQUEyQjtJQUUzQixNQUFNLG9DQUFvQyxHQUFHLGtCQUFrQixDQUFDLElBQUksQ0FDbEUsUUFBUSxDQUFDLENBQUMsQ0FBQyxFQUNYLFNBQVMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFO1FBQ25CLE9BQU8sb0NBQW9DLENBQ3pDLE1BQU0sRUFDTixNQUFNLENBQUMsT0FBTyxDQUFDLGVBQWUsRUFDOUIsbUJBQW1CLENBQ3BCLENBQUM7SUFDSixDQUFDLENBQUMsRUFDRixXQUFXLEVBQUUsQ0FDZCxDQUFDO0lBRUYsTUFBTSxzQ0FBc0MsR0FBRyxjQUFjLENBQzNELG9DQUFvQyxDQUNyQyxDQUFDO0lBRUYsTUFBTSxvQ0FBb0MsR0FBRyxtQkFBbUI7UUFDOUQsQ0FBQyxDQUFDLGVBQWUsQ0FDYixNQUFNLEVBQ04sc0NBQWtGLENBQ25GO1FBQ0gsQ0FBQyxDQUFDLEtBQUssQ0FBQztJQUVWLE1BQU0sMkNBQTJDLEdBQy9DLGNBQWMsQ0FBbUMsb0NBQW9DLENBQUMsQ0FBQztJQUV6RixPQUFPLE1BQU0sQ0FDWCxvQ0FBb0MsRUFDcEMsc0NBQXNDLEVBQ3RDLG9DQUFvQyxFQUNwQywyQ0FBMkMsQ0FDNUMsQ0FBQztBQUNKLENBQUM7QUFFRDs7R0FFRztBQUNILE1BQU0sVUFBZ0Isb0NBQW9DLENBQ3hELE1BQWMsRUFDZCxrQkFBMEIsRUFDMUIsbUJBQTJCOztRQUUzQixrQkFBa0IsQ0FBQztRQUNuQixNQUFNLGtCQUFrQixHQUFHLEdBQVMsRUFBRTtZQUNwQyxPQUFPLG1CQUFtQjtnQkFDeEIsQ0FBQyxDQUFDLElBQUksMENBQTBDLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBTSxDQUFDLG1CQUFtQixDQUFDO2dCQUNwRixDQUFDLENBQUMsTUFBTSxJQUFJLHNDQUFzQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQztvQkFDOUQsUUFBUSxFQUFFLE9BQVM7aUJBQ3BCLENBQUMsQ0FBQztRQUNULENBQUMsQ0FBQSxDQUFDO1FBRUYsT0FBTyxtQkFBbUI7WUFDeEIsQ0FBQyxDQUFDLG1CQUFtQixDQUNqQiwwQ0FBMEMsQ0FBQyxHQUFHLEVBQzlDLGtCQUFrQixFQUNsQixhQUFhLENBQUMsa0JBQWtCLEVBQ2hDLE1BQU0sQ0FDUDtZQUNILENBQUMsQ0FBQyxjQUFjLENBQUMsa0JBQWtCLEVBQUUsYUFBYSxDQUFDLGtCQUFrQixDQUFDLENBQUM7SUFDM0UsQ0FBQztDQUFBO0FBRUQsU0FBUyxlQUFlLENBQ3RCLE1BQWMsRUFDZCxpQ0FBMkU7SUFFM0UsT0FBTyxVQUFVLENBQ2YsaUNBQWlDLEVBQ2pDLElBQUksMENBQTBDLENBQUMsTUFBTSxDQUFDLEVBQ3RELEdBQVMsRUFBRTtRQUNULE9BQU8sRUFBRSxDQUFDO0lBQ1osQ0FBQyxDQUFBLENBQ0YsQ0FBQztBQUNKLENBQUMifQ==